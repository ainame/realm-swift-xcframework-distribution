name: Build and Release XCFramework

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Realm Swift git tag to build (e.g., v20.0.3)"
        required: true
        default: "v20.0.3"
        type: string
      xcode-version:
        description: "Xcode version to use (e.g., 26.2)"
        required: true
        default: "26.2"
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-26
    name: Build Realm Swift ${{ inputs.tag }} with Xcode ${{ inputs.xcode-version }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          path: distribution

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}

      - name: Verify Xcode version
        run: |
          xcodebuild -version
          xcrun --show-sdk-path

      - name: Clone Realm Swift at tag ${{ inputs.tag }}
        run: |
          git clone --depth 1 --branch ${{ inputs.tag }} https://github.com/realm/realm-swift.git realm-swift
          cd realm-swift
          echo "Cloned Realm Swift at tag $(git describe --tags)"
          git log -1 --oneline

      - name: Apply patches
        working-directory: realm-swift
        run: |
          echo "Applying patches..."
          for patch in ../distribution/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying $patch"
              git apply --verbose "$patch"
            fi
          done

      - name: Download Realm Core
        working-directory: realm-swift
        run: sh build.sh download-core

      - name: Build iOS XCFramework
        working-directory: realm-swift
        run: |
          # Unset GITHUB_WORKSPACE so build.sh uses $(pwd) instead
          unset GITHUB_WORKSPACE
          # Build for iOS only (includes both device and simulator)
          sh build.sh ios-swift
        env:
          DEVELOPER_DIR: /Applications/Xcode_${{ inputs.xcode-version }}.app/Contents/Developer

      - name: Create XCFrameworks
        working-directory: realm-swift
        run: |
          # Create xcframeworks for iOS
          mkdir -p build/Release

          # Find all built Realm.framework and create xcframework
          find build/DerivedData/Realm/Build/Products -name 'Realm.framework' \
            | sed 's/.*/-framework &/' \
            | xargs xcodebuild -create-xcframework -allow-internal-distribution \
              -output "build/Release/Realm.xcframework"

          # Find all built RealmSwift.framework and create xcframework
          find build/DerivedData/Realm/Build/Products -name 'RealmSwift.framework' \
            | sed 's/.*/-framework &/' \
            | xargs xcodebuild -create-xcframework -allow-internal-distribution \
              -output "build/Release/RealmSwift.xcframework"

          # Fix Swift interface naming collisions (from build.sh)
          find "build/Release/RealmSwift.xcframework" -name "*.swiftinterface" \
            -exec sed -i '' 's/Realm\.//g' {} \; \
            -exec sed -i '' 's/import Private/import Realm.Private\nimport Realm.Swift/g' {} \; \
            -exec sed -i '' 's/RealmSwift.Configuration/RealmSwift.Realm.Configuration/g' {} \; \
            -exec sed -i '' 's/extension Configuration/extension Realm.Configuration/g' {} \; \
            -exec sed -i '' 's/RealmSwift.Error[[:>:]]/RealmSwift.Realm.Error/g' {} \; \
            -exec sed -i '' 's/extension Error/extension Realm.Error/g' {} \; \
            -exec sed -i '' 's/RealmSwift.AsyncOpenTask/RealmSwift.Realm.AsyncOpenTask/g' {} \; \
            -exec sed -i '' 's/RealmSwift.UpdatePolicy/RealmSwift.Realm.UpdatePolicy/g' {} \; \
            -exec sed -i '' 's/RealmSwift.Notification[[:>:]]/RealmSwift.Realm.Notification/g' {} \; \
            -exec sed -i '' 's/RealmSwift.OpenBehavior/RealmSwift.Realm.OpenBehavior/g' {} \; \
            -exec sed -i '' 's/Ï„_1_0/V/g' {} \;

      - name: Package XCFrameworks
        working-directory: realm-swift
        run: |
          cd build/Release

          # Create zip files with SPM naming convention
          # Both need Xcode version (binaries differ between Xcode versions)
          zip -r "Realm@${{ inputs.xcode-version }}.spm.zip" Realm.xcframework
          zip -r "RealmSwift@${{ inputs.xcode-version }}.spm.zip" RealmSwift.xcframework

          # Show what was created
          ls -lh *.zip

      - name: Get version from dependencies
        id: get-version
        working-directory: realm-swift
        run: |
          VERSION=$(sed -n 's/^VERSION=\(.*\)$/\1/p' dependencies.list)
          CORE_VERSION=$(sed -n 's/^REALM_CORE_VERSION=\(.*\)$/\1/p' dependencies.list)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "CORE_VERSION=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "Realm Swift Version: $VERSION"
          echo "Realm Core Version: $CORE_VERSION"

      - name: Calculate checksums
        id: checksums
        working-directory: realm-swift/build/Release
        run: |
          # Calculate SHA256 checksums for SPM
          REALM_CHECKSUM=$(swift package compute-checksum "Realm@${{ inputs.xcode-version }}.spm.zip")
          REALMSWIFT_CHECKSUM=$(swift package compute-checksum "RealmSwift@${{ inputs.xcode-version }}.spm.zip")

          echo "REALM_CHECKSUM=$REALM_CHECKSUM" >> $GITHUB_OUTPUT
          echo "REALMSWIFT_CHECKSUM=$REALMSWIFT_CHECKSUM" >> $GITHUB_OUTPUT

          echo "Realm@${{ inputs.xcode-version }} checksum: $REALM_CHECKSUM"
          echo "RealmSwift@${{ inputs.xcode-version }} checksum: $REALMSWIFT_CHECKSUM"

      - name: Create Release Notes
        id: release-notes
        run: |
          cat > release_notes.md <<EOF
          Community-built XCFramework for Realm Swift ${{ steps.get-version.outputs.VERSION }}.

          Built with Xcode ${{ inputs.xcode-version }} for iOS (device + simulator).

          ## Swift Package Manager

          Add to your \`Package.swift\`:

          \`\`\`swift
          .binaryTarget(
              name: "Realm",
              url: "https://github.com/ainame/realm-swift-xcframework-distribution/releases/download/${{ inputs.tag }}/Realm@${{ inputs.xcode-version }}.spm.zip",
              checksum: "${{ steps.checksums.outputs.REALM_CHECKSUM }}"
          ),
          .binaryTarget(
              name: "RealmSwift",
              url: "https://github.com/ainame/realm-swift-xcframework-distribution/releases/download/${{ inputs.tag }}/RealmSwift@${{ inputs.xcode-version }}.spm.zip",
              checksum: "${{ steps.checksums.outputs.REALMSWIFT_CHECKSUM }}"
          )
          \`\`\`

          ---

          **Built from**: https://github.com/realm/realm-swift/tree/${{ inputs.tag }}
          **Unsigned** | **iOS only**
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ inputs.tag }}"
          REPO="${{ github.repository }}"

          # Check if release already exists
          if gh release view "$RELEASE_TAG" --repo "$REPO" >/dev/null 2>&1; then
            echo "Release $RELEASE_TAG already exists, adding Xcode ${{ inputs.xcode-version }} build..."

            # Upload both frameworks for this Xcode version
            gh release upload "$RELEASE_TAG" \
              "realm-swift/build/Release/Realm@${{ inputs.xcode-version }}.spm.zip" \
              "realm-swift/build/Release/RealmSwift@${{ inputs.xcode-version }}.spm.zip" \
              --repo "$REPO" \
              --clobber

            echo "Note: Release notes NOT updated (shows last build info)"
          else
            echo "Creating new release $RELEASE_TAG..."
            gh release create "$RELEASE_TAG" \
              --repo "$REPO" \
              --title "Realm Swift ${{ steps.get-version.outputs.VERSION }}" \
              --notes-file release_notes.md \
              "realm-swift/build/Release/Realm@${{ inputs.xcode-version }}.spm.zip" \
              "realm-swift/build/Release/RealmSwift@${{ inputs.xcode-version }}.spm.zip"
          fi

          echo "âœ… Release created: https://github.com/$REPO/releases/tag/$RELEASE_TAG"

      - name: Upload build artifacts (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ inputs.tag }}
          path: |
            realm-swift/build/**/*.log
            realm-swift/build/DerivedData/Realm/Logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: \`${{ inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.get-version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Xcode**: ${{ inputs.xcode-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Realm.xcframework.zip" >> $GITHUB_STEP_SUMMARY
          echo "- RealmSwift.xcframework.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Release" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ inputs.tag }})" >> $GITHUB_STEP_SUMMARY
